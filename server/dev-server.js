const Koa = require( 'koa' );const json = require( 'koa-json' );const api = require( './api' );const webpack = require( 'webpack' );const hotMiddleware = require( 'koa-webpack-hot-middleware' );const devMiddleware = require( 'koa-webpack-dev-middleware' );const historyApiFallback = require( 'koa2-connect-history-api-fallback' );const config = require( '../config/webpack.config.dev' );const WebSocketApi = require( './util/ws' );const http = require( 'http' );const WebSocket = require( 'ws' );const app = new Koa();const port = 3000;const uri = 'http://localhost:' + port;const compiler = webpack( config );const instance = devMiddleware( compiler, {	publicPath: '/',	quiet: false,	stats: {		colors: true	}} );app.use( historyApiFallback( {	htmlAcceptHeaders: [ 'text/html', 'application/xhtml+xml' ]} ) )app.use( instance );app.use( hotMiddleware( compiler, {	log: false,	heartbeat: 10000,} ) );app.use( json() );app.use( async ( ctx, next ) => {	let start = new Date();	await next();	let ms = new Date() - start;	console.log( '%s %s - %s', ctx.method, ctx.url, ms );} )app.use( async ( ctx, next ) => {  //  如果JWT验证失败，返回验证失败信息	try {		await next();	} catch ( err ) {		if ( err.status === 401 ) {			ctx.status = 401;			ctx.body = {				success: false,				token: null,				info: 'Protected resource, use Authorization header to get access'			}		} else {			throw err		}	}} )app.use( api.routes() );app.use( api.allowedMethods() );app.on( 'error', ( err ) => {	console.log( 'server error', err );} )const server = http.createServer( app.callback() );const wss = new WebSocket.Server( {	server} );WebSocketApi( wss )console.log( '> Starting dev server...' );server.listen( port, () => {	console.log( '> Listening at ' + uri + '\n' )} )