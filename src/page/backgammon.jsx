import React, { Component } from 'react';import { message, Input, Button, List, Row, Col, Tag, Space, Avatar, notification, Switch } from 'antd';import "../assets/css/backgammon.css"const { Search } = Input;/** * 五子棋对战 * */class Index extends Component {  constructor ( props ) {    super( props );    this.state = {      status: 0,      onLineList: [],      chatList: [],      value: "",    };    this.webSocket = null;    this.roomId = null;    this.firstMove = false;    this.dealBackgammonMessage = null;  }  componentDidMount () {    this.webSocket = this.createWebSocket( `ws://192.168.31.241:3000` );    this.webSocket.onopen = () => message.success( '连接成功' );    this.webSocket.onmessage = this.dealMessage.bind( this );  }  componentWillUnmount () {    message.success( '连接关闭' );    this.webSocket.send( JSON.stringify( { type: 'close' } ) )  }  createWebSocket ( urlValue ) {    if ( window.WebSocket ) return new WebSocket( urlValue );    message.error( '对不起，您的浏览器不支持websocket' );    return false;  }  dealMessage ( msg ) {    console.log( JSON.parse( msg.data ) );    const { type, data } = JSON.parse( msg.data );    if ( type.includes( 'backgammon' ) ) {      this.dealBackgammonMessage( type, data )    } else {      switch ( type ) {        case 'onLineIpList':          this.setState( { onLineList: data } );          break;        case 'invite':          let key = Math.random().toString();          notification.open( {            message: '新的消息',            description: `IP: ${ data.rivalIp } 的用户邀请您对战，是否接受？`,            btn: (              <Space>                <Button type="primary" size="small" onClick={ this.handleReply.bind( this, key, 'accept', data.roomId ) }>                  接受                </Button>                <Button type="primary" danger size="small"                        onClick={ this.handleCloseNotification.bind( this, key, data.roomId ) }>                  拒绝                </Button>              </Space>            ),            duration: 5,            key,            onClose: this.handleReply.bind( this, key, 'reject', data.roomId )          } );          break;        case "open-room":          message.success( '进入房间' );          this.roomId = data.roomId;          this.firstMove = data.firstMove;          this.setState( { status: 1 } )          break;        case "reject":          notification.open( {            message: '新的消息',            description: `对方拒绝了您的邀请`,            duration: 5,            key: Math.random().toString(),          } );          break;        case "chat":          let chatList = [].concat( this.state.chatList );          chatList.push( {            direction: 'left',            avatarText: '对手',            content: data.content,            contentBg: "#FFFFFF"          } );          this.setState( { chatList } );          break;      }    }  }  handleReply ( key, type, roomId ) {    notification.close( key );    this.webSocket.send( JSON.stringify( { type: 'reply', data: { roomId, type } } ) );  }  handleCloseNotification ( key, roomId ) {    this.handleReply( key, 'reject', roomId );  }  handleLaunch ( id ) {    this.webSocket.send( JSON.stringify( { type: 'launch', data: id } ) );  }  handleChat ( value ) {    let chatList = [].concat( this.state.chatList );    chatList.push( {      direction: 'right',      avatarText: '我',      content: value,      contentBg: "#9EEA6A"    } );    this.setState( { chatList, value: "" } );    this.webSocket.send( JSON.stringify( {      type: 'chat',      data: {        roomId: this.roomId,        content: value      }    } ) );  }  handleChange ( e ) {    this.setState( { value: e.target.value } );  }  render () {    const { onLineList, status, chatList, value } = this.state;    return (      <Row style={ { padding: '15px' } }>        <Col offset={ 1 } span={ 16 }>{/*          {            status === 0 && (              <Button onClick={ this.handleSend.bind( this ) }>发送</Button>            )          }*/}          {            status === 1 && (              <Backgammon                roomId={ this.roomId }                firstMove={ this.firstMove }                webSocket={ this.webSocket }                trigger={ trigger => this.dealBackgammonMessage = trigger.dealMassage }              />            )          }        </Col>        <Col offset={ 1 } span={ 5 }>          <Space direction="vertical" style={ { width: '100%' } }>            <List              header={ <div>在线列表</div> }              pagination={ {                position: 'bottom',                total: onLineList.length,                pageSize: 10              } }              bordered              size="small"              dataSource={ onLineList }              renderItem={ item => (                <List.Item>                  { item.ip }                  { item.isUser && <Tag color="#f50" style={ { float: "right" } }>我</Tag> }                  { !item.isUser && <Button size="small" style={ { float: "right" } }                                            onClick={ this.handleLaunch.bind( this, item.id ) }>发起对战</Button> }                </List.Item>              ) }            />            {              status === 1 && (                <div>                  <div                    style={ {                      padding: '15px',                      height: '300px',                      border: '1px solid #d9d9d9',                      borderBottom: 'none',                      overflow: 'auto',                      background: '#F5F5F5'                    } }                  >                    <Space                      direction="vertical"                      style={ {                        width: '100%'                      } }                    >                      {                        chatList.map( ( item, index ) => (                          <ChatItem                            key={ index }                            direction={ item.direction }                            avatarText={ item.avatarText }                            content={ item.content }                            contentBg={ item.contentBg }                          />                        ) )                      }                    </Space>                  </div>                  <Search                    value={ value }                    placeholder="回车发送"                    enterButton="发送"                    onSearch={ this.handleChat.bind( this ) }                    onChange={ this.handleChange.bind( this ) }                  />                </div>              )            }          </Space>        </Col>      </Row>    );  }}class ChatItem extends Component {  render () {    const { direction = 'right', avatarText = "", content = "", contentBg = "#FFFFFF" } = this.props;    return (      <div        style={ { display: 'flex', alignItem: 'center', flexDirection: direction === 'left' ? 'row' : 'row-reverse' } }      >        <div style={ { [ `margin${ direction === 'left' ? 'Right' : 'Left' }` ]: '8px' } }>          <Avatar style={ { color: '#f56a00', backgroundColor: '#fde3cf' } }>{ avatarText }</Avatar>        </div>        <div          style={ {            maxWidth: 'calc(100% - 80px)',            background: contentBg,            borderRadius: '3px',            padding: '2px 5px',            fontSize: '13px',            wordBreak: 'break-all',            display: 'flex',            alignItems: 'center'          } }        >          { content }        </div>      </div>    )  }}class Backgammon extends Component {  constructor ( props ) {    super( props );    this.state = {      history: [],      firstMove: props.firstMove    };    this.webSocket = props.webSocket;    this.config = {      x: 17,      y: 17    };    this.point = this.showPoint();    this.trigger = { dealMassage: this.dealMassage.bind( this ) };  }  componentWillMount () {    const { trigger } = this.props;    trigger && trigger( this.trigger );  }  dealMassage ( type, data ) {    switch ( type ) {      case "backgammon-":    }  }  showPoint () {    const { x, y } = this.config;    const i = Math.floor( x / 2 );    const j = Math.floor( y / 2 );    return [      this.formatPoint( i - 5, j - 5 ), this.formatPoint( i, j - 5 ), this.formatPoint( i + 5, j - 5 ),      this.formatPoint( i - 5, j ), this.formatPoint( i, j ), this.formatPoint( i + 5, j ),      this.formatPoint( i - 5, j + 5 ), this.formatPoint( i, j + 5 ), this.formatPoint( i + 5, j + 5 ),    ]  }  formatPoint ( i, j ) {    return `${ i }-${ j }`  }  handleClick ( i, j ) {    const { firstMove } = this.state;    let history = [].concat( this.state.history );    if ( ( firstMove && history.length % 2 === 0 ) || ( !firstMove && history.length % 2 !== 0 ) ) {      this.handleSend( {        type: 'backgammon-point',        data: {          roomId: this.roomId,          i,          j        }      } )    }    history.push( this.formatPoint( i, j ) );    this.setState( { history } );  }  handleSend ( data ) {    this.webSocket.send( JSON.stringify( data ) );  }  renderFormItem ( label, content ) {    return (      <Space>        <div className="backgammon-label">{ label }<span>：</span></div>        <div className="backgammon-content">{ content }</div>      </Space>    )  }  render () {    const { history, firstMove } = this.state;    const { x, y } = this.config;    return (      <div className="backgammon">        <div>          <div className="backgammon-container">            {              (new Array( y )).fill( 0 ).map( ( item, j ) => (                <div className="backgammon-row" key={ j }>                  {                    (new Array( x )).fill( 0 ).map( ( item, i ) => {                      let className = "";                      const format = this.formatPoint( i, j )                      const index = history.indexOf( format );                      if ( index > -1 ) {                        className = index % 2 === 0 ? "backgammon-white" : "backgammon-black";                      } else if ( this.point.includes( format ) ) {                        className = "backgammon-anchor";                      }                      return (                        <div className="backgammon-col" key={ `${ i }-${ j }` }                             onClick={ this.handleClick.bind( this, i, j ) }>                          <div className={ className }/>                        </div>                      )                    } )                  }                </div>              ) )            }          </div>          <Space className="backgammon-operating" direction="vertical">            <div className="title">信息</div>            { this.renderFormItem( '当前执棋者', '白棋（ 我 ）' ) }            { this.renderFormItem( '对局结果', '对战中' ) }            <div className="title">操作</div>            { this.renderFormItem( '切换对方先手', <Switch disabled={ !firstMove } /> ) }          </Space>        </div>      </div>    )  }}export default Index;